<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Windy ê²½ë¡œ â†’ WPT ë³€í™˜ê¸°</title>
  <style>
    :root {
      --primary-color: #00aaff;
      --bg-color: #f4f7f6;
      --card-bg: #ffffff;
    }
    body { 
      font-family: 'Pretendard', system-ui, -apple-system, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background-color: var(--bg-color);
      color: #333;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      background: var(--card-bg);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    }
    h1 { font-size: 1.5rem; margin-bottom: 20px; color: #1a1a1a; display: flex; align-items: center; gap: 10px; }
    label { display:block; font-weight: 600; margin: 20px 0 8px; font-size: 0.9rem; }
    textarea, input { 
      width: 100%; 
      box-sizing: border-box; 
      padding: 15px; 
      border: 2px solid #eee; 
      border-radius: 12px; 
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    textarea:focus, input:focus { outline: none; border-color: var(--primary-color); }
    textarea { min-height: 120px; resize: vertical; font-family: monospace; }
    
    .button-group { margin-top: 25px; }
    button { 
      width: 100%;
      padding: 15px; 
      border: 0; 
      border-radius: 12px; 
      cursor: pointer; 
      font-weight: 700; 
      font-size: 1rem;
      background: var(--primary-color);
      color: white;
      transition: transform 0.1s, opacity 0.2s;
    }
    button:active { transform: scale(0.98); }
    button:hover { opacity: 0.9; }

    .hint { 
      background: #eef9ff; 
      padding: 15px; 
      border-radius: 12px; 
      font-size: 0.85rem; 
      color: #446688; 
      line-height: 1.6;
    }
    .hint a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: bold;
    }
    .hint a:hover {
      text-decoration: underline;
    }
    .out { 
      margin-top: 25px; 
      padding: 20px; 
      border: 2px dashed #ddd; 
      border-radius: 15px; 
      background: #fafafa; 
    }
    #status { font-weight: 600; margin-bottom: 10px; }
    .error { color: #d32f2f; }
    .ok { color: #2e7d32; }
    
    #preview { 
      white-space: pre; 
      overflow: auto; 
      max-height: 200px; 
      font-size: 0.85rem; 
      background: #eee; 
      padding: 10px; 
      border-radius: 8px;
      margin-top: 10px;
      display: none;
    }
    
    .download-btn {
      display: none;
      margin-top: 15px;
      text-align: center;
      text-decoration: none;
      background: #2e7d32;
      color: white;
      padding: 12px;
      border-radius: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>ğŸ“ Windy URL â†’ WPT ë³€í™˜ê¸° </h1>
  
  <div class="hint">
    â€¢ Windyì˜ <b>Route Planner URL</b> ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.<br/>
    â€¢ íŒŒì¼ëª…ì€ ê¸°ë³¸ì ìœ¼ë¡œ <b>í˜„ì¬ ë‚ ì§œ_ì‹œê°„_</b> í˜•ì‹ìœ¼ë¡œ ì§€ì •ë©ë‹ˆë‹¤.<br/>
    â€¢ ì œì‘ : ë‹ë¦¬ë¦¬(í™ìƒì§„) of ì—´í’íŒ¨ëŸ¬<br/>
    â€¢ ì±„ë„ : <a href="https://www.youtube.com/@HotwindPara" target="_blank">https://www.youtube.com/@HotwindPara</a><br/>
  </div>

  <label for="urlInput">Windy URL ë˜ëŠ” ë°ì´í„° ì…ë ¥</label>
  <textarea id="urlInput" placeholder="https://www.windy.com/route-planner/ifr/35.6735,128.4113;..."></textarea>

  <label for="fileTitle">ì €ì¥í•  íŒŒì¼ëª…</label>
  <input id="fileTitle" type="text" placeholder="ì˜ˆ: 2023102414_" />

  <div class="button-group">
    <button id="convertBtn">WPT íŒŒì¼ ìƒì„±í•˜ê¸°</button>
  </div>

  <div class="out">
    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <div id="preview"></div>
    <a id="downloadLink" class="download-btn" download>íŒŒì¼ ë‹¤ìš´ë¡œë“œ (.wpt)</a>
  </div>
</div>

<script>
const $ = (id) => document.getElementById(id);
let lastObjectUrl = null;

// í˜ì´ì§€ ë¡œë“œ ì‹œ íŒŒì¼ëª… ê¸°ë³¸ê°’ ì„¸íŒ… (yyyyMMddHH_)
window.addEventListener('DOMContentLoaded', () => {
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  const dd = String(now.getDate()).padStart(2, '0');
  const hh = String(now.getHours()).padStart(2, '0');
  
  const datePrefix = `${yyyy}${mm}${dd}${hh}_`;
  $("fileTitle").value = datePrefix; 
});

$("convertBtn").addEventListener("click", () => {
  try {
    resetUI();
    const input = $("urlInput").value.trim();
    const title = ($("fileTitle").value.trim() || "target").replace(/[\\/:*?"<>|]+/g, "_");

    if (!input) throw new Error("URL í˜¹ì€ ë°ì´í„°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

    let waypoints = [];

    // 1. Windy Route Planner íŒ¨í„´ í™•ì¸ (ifr ê²½ë¡œ í¬í•¨ ëŒ€ì‘)
    const routeMatch = input.match(/\/route-planner\/(?:ifr\/)?([\d\.,;-]+)/);
    
    if (routeMatch && routeMatch[1]) {
      const coordString = routeMatch[1].split('?')[0]; 
      const pairs = coordString.split(';').filter(p => p.trim() !== "");
      
      waypoints = pairs.map((pair, idx) => {
        const parts = pair.split(',');
        const lat = parseFloat(parts[0]);
        const lon = parseFloat(parts[1]);
        return { name: `WP${idx + 1}`, lat, lon, desc: "Windy Route" };
      }).filter(p => !isNaN(p.lat) && !isNaN(p.lon));
    }

    // 2. Windy íŒ¨í„´ì—ì„œ ëª» ì°¾ì•˜ë‹¤ë©´ ê¸°ì¡´ value íŒŒë¼ë¯¸í„° ì‹œë„
    if (waypoints.length === 0) {
      const valueRaw = extractValueParam(input);
      if (valueRaw) {
        const gpxXml = decodeValueToGpxXml(valueRaw);
        waypoints = parseGpxWaypoints(gpxXml);
      }
    }

    if (waypoints.length === 0) {
      throw new Error("URL êµ¬ì¡°ì—ì„œ ì¢Œí‘œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    const wptContent = generateOziWpt(waypoints);
    
    $("status").textContent = `ì„±ê³µ! ì¢Œí‘œ ${waypoints.length}ê°œë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤.`;
    $("status").className = "ok";
    $("preview").textContent = wptContent;
    $("preview").style.display = "block";
    
    const blob = new Blob([wptContent], { type: "text/plain;charset=utf-8" });
    const objUrl = URL.createObjectURL(blob);
    lastObjectUrl = objUrl;
    
    const dLink = $("downloadLink");
    dLink.href = objUrl;
    dLink.download = `${title}.wpt`;
    dLink.style.display = "block";
    dLink.textContent = `${title}.wpt ë‹¤ìš´ë¡œë“œ`;

  } catch (e) {
    $("status").textContent = "ì˜¤ë¥˜: " + e.message;
    $("status").className = "error";
  }
});

function resetUI() {
  $("status").textContent = "ë³€í™˜ ì¤‘...";
  $("status").className = "";
  $("preview").style.display = "none";
  $("downloadLink").style.display = "none";
  if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
}

function extractValueParam(urlText) {
  try {
    const u = new URL(urlText);
    return u.searchParams.get("value");
  } catch (_) {
    const idx = urlText.indexOf("value=");
    if (idx === -1) return null;
    const after = urlText.slice(idx + 6);
    const amp = after.indexOf("&");
    return amp === -1 ? after : after.slice(0, amp);
  }
}

function decodeValueToGpxXml(raw) {
  const decoded = decodeURIComponent(raw.replace(/\+/g, "%20"));
  if (decoded.includes("<gpx")) return decoded;
  
  try {
    const b64 = decoded.replace(/-/g, "+").replace(/_/g, "/");
    return atob(b64);
  } catch { return decoded; }
}

function parseGpxWaypoints(xml) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(xml, "application/xml");
  const nodes = Array.from(doc.querySelectorAll("wpt, rtept, trkpt"));
  return nodes.map((n, i) => ({
    name: n.querySelector("name")?.textContent || `PT${i+1}`,
    lat: parseFloat(n.getAttribute("lat")),
    lon: parseFloat(n.getAttribute("lon")),
    desc: n.querySelector("desc")?.textContent || ""
  })).filter(p => !isNaN(p.lat) && !isNaN(p.lon));
}

function generateOziWpt(pts) {
  let lines = [
    "OziExplorer Waypoint File Version 1.1",
    "WGS 84",
    "Reserved 2",
    "Reserved 3"
  ];

  pts.forEach((p, i) => {
    const row = [
      i + 1,
      p.name.replace(/,/g, ""),
      p.lat.toFixed(6),
      p.lon.toFixed(6),
      0, 1, 0, 0, 0, 0,
      (p.desc || "Windy Point").replace(/,/g, " "),
      0, 0, 0, 0, 0, 0, 0, 0, 0
    ];
    lines.push(row.join(","));
  });

  return lines.join("\r\n") + "\r\n";
}
</script>

</body>

</html>
